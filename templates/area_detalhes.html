{% extends 'base.html' %}

{% block title %}
  {{ area.nome }} - Detalhes
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <!-- Título da Página -->
    <h2 class="mb-3">{{ area.nome }} ({{ area.tipo_armazenamento | capitalize }})</h2>
    
    <!-- Link para Voltar -->
    <a href="{{ url_for('pagina_inicial_armazem') }}" class="btn btn-secondary mb-3">
      <i class="fas fa-arrow-left"></i> Voltar para Visão Geral
    </a>

    <!-- Alertas -->
    {% include '_alerts.html' %}

    <!-- Tabela de Produtos -->
    <h4>Produtos na Área</h4>
    {% if produtos %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="thead-dark">
            <tr>
              <th>Produto</th>
              <th>Lote</th>
              <th>Quantidade</th>
              <th>Validade</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for produto in produtos %}
              <tr>
                <td>{{ produto.nome }}</td>
                <td>{{ produto.lote }}</td>
                <td>{{ produto.quantidade }}</td>
                <td>{{ produto.data_validade }}</td>
                <td>
                  {% set dias_para_vencer = (produto.data_validade | to_date - data_hoje).days %}
                  {% if produto.data_validade < data_hoje %}
                    <span class="badge badge-danger">VENCIDO</span>
                  {% elif dias_para_vencer <= 7 %}
                    <span class="badge badge-warning">Próximo Val.</span>
                  {% else %}
                    <span class="badge badge-success">OK</span>
                  {% endif %}
                </td>
                <td>
                  <button type="button" class="btn btn-primary btn-sm" 
                          data-toggle="modal" 
                          data-target="#vendaModal"
                          data-produto-nome="{{ produto.nome }}"
                          data-produto-id="{{ produto.id_catalogo_produto }}"
                          data-lote="{{ produto.lote }}">
                    <i class="fas fa-shopping-cart"></i> Vender
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        Nenhum produto encontrado nesta área.
      </div>
    {% endif %}

    <!-- Formulário para Adicionar Produto (apenas para gerentes) -->
    {% if usuario_logado and usuario_logado.funcao == 'gerente' %}
      <div class="card mt-4">
        <div class="card-header">
          <h5>Adicionar Produto a esta Área ({{ area.nome }})</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('adicionar_produto_na_area', id_area=area.id_area) }}">
            <div class="form-group">
              <label for="id_produto_catalogo">Produto do Catálogo</label>
              <select class="form-control" id="id_produto_catalogo" name="id_produto_catalogo" required>
                {% for id_produto, prod_data in produtos_catalogo.items() %}
                  <option value="{{ id_produto }}">{{ prod_data.nome }} (ID: {{ id_produto }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="quantidade">Quantidade</label>
              <input type="number" class="form-control" id="quantidade" name="quantidade" min="1" required>
            </div>
            <div class="form-group">
              <label for="data_validade">Data de Validade</label>
              <input type="date" class="form-control" id="data_validade" name="data_validade" required>
            </div>
            <div class="form-group">
              <label for="lote">Lote</label>
              <input type="text" class="form-control" id="lote" name="lote" required>
            </div>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-plus"></i> Adicionar Produto
            </button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal para Registrar Venda -->
  <div class="modal fade" id="vendaModal" tabindex="-1" role="dialog" aria-labelledby="vendaModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="vendaModalLabel">Registrar Venda</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="POST" action="{{ url_for('vender_produto_da_area', id_area=area.id_area) }}">
          <div class="modal-body">
            <div class="form-group">
              <label for="produto_nome_venda">Produto</label>
              <input type="text" class="form-control" id="produto_nome_venda" readonly>
            </div>
            <div class="form-group">
              <label for="lote_venda">Lote</label>
              <input type="text" class="form-control" id="lote_venda" name="lote_venda" readonly>
            </div>
            <input type="hidden" id="id_produto_catalogo_venda" name="id_produto_catalogo_venda">
            <div class="form-group">
              <label for="quantidade_venda">Quantidade a Vender</label>
              <input type="number" class="form-control" id="quantidade_venda" name="quantidade_venda" min="1" required>
            </div>
            <div class="form-group">
              <label for="destino_venda">Destino da Venda</label>
              <input type="text" class="form-control" id="destino_venda" name="destino_venda" value="Cliente Balcão" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Confirmar Venda</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% block scripts %}
  <script>
    $('#vendaModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var produtoNome = button.data('produto-nome');
      var produtoId = button.data('produto-id');
      var lote = button.data('lote');
      
      var modal = $(this);
      modal.find('#produto_nome_venda').val(produtoNome);
      modal.find('#id_produto_catalogo_venda').val(produtoId);
      modal.find('#lote_venda').val(lote);
    });
  </script>
{% endblock %}
{% endblock %}